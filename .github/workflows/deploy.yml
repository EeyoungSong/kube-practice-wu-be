name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch: # ìˆ˜ë™ ë°°í¬ í—ˆìš©

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 300s
          script: |
            set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

            echo "ğŸ”¹ ì´ë™: í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬"
            cd /home/ubuntu/django_practice

            # ìµœì‹  ì½”ë“œ ê°±ì‹  (pull ëŒ€ì‹  fetch + reset)
            echo "ğŸ”¹ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
            git fetch origin main
            git reset --hard origin/main

            # .env íŒŒì¼ ì—…ë°ì´íŠ¸ í•„ìš” ì‹œì—ë§Œ ìƒì„±
            # ìƒˆ env ë‚´ìš©ì„ ì„ì‹œ íŒŒì¼ë¡œ ì‘ì„±
            cat > .env.tmp << EOF
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DEBUG=0
            REDIS_URL=redis://redis:6379/0  
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            EOF

            # ì´ì „ .envì™€ ë‚´ìš©ì´ ë‹¤ë¥¼ ë•Œë§Œ ë®ì–´ì“°ê¸°
            if ! cmp -s .env.tmp .env 2>/dev/null; then
              echo "ğŸ”¹ .env íŒŒì¼ ë³€ê²½ ê°ì§€ â€” ê°±ì‹  ì¤‘..."
              mv .env.tmp .env
            else
              echo "âœ… .env íŒŒì¼ ë™ì¼ â€” ì¬ìƒì„± ìƒëµ"
              rm .env.tmp
            fi

            # SSL ì¸ì¦ì„œ í™•ì¸ (ì—†ìœ¼ë©´ ìµœì´ˆ 1íšŒë§Œ ìƒì„±)
            if [ ! -f /etc/ssl/certs/selfsigned.crt ]; then
              echo "ğŸ”¹ SSL ì¸ì¦ì„œ ìƒì„±..."
              sudo mkdir -p /etc/ssl/certs /etc/ssl/private
              sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout /etc/ssl/private/selfsigned.key \
                -out /etc/ssl/certs/selfsigned.crt \
                -subj "/C=KR/ST=Seoul/L=Seoul/O=Organization/CN=${{ secrets.EC2_HOST }}"
            else
              echo "âœ… SSL ì¸ì¦ì„œ ì´ë¯¸ ì¡´ì¬ â€” ìƒëµ"
            fi

            # Docker ì´ë¯¸ì§€ ë¹Œë“œ (ìºì‹œ ì¬ì‚¬ìš©)
            echo "ğŸ”¹ Docker ì´ë¯¸ì§€ ë¹Œë“œ (ìºì‹œ ì‚¬ìš©)..."
            docker compose -f docker-compose.prod.yml build

            # ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ë‹¤ìš´ ì—†ì´ ë¹ ë¥´ê²Œ)
            echo "ğŸ”¹ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            docker compose -f docker-compose.prod.yml up -d --build

            # ìƒíƒœ í™•ì¸
            echo "ğŸ”¹ ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."
            sleep 15
            docker compose -f docker-compose.prod.yml ps

            # ì˜¤ë˜ëœ ì´ë¯¸ì§€ ì •ë¦¬ (24ì‹œê°„ ì´ìƒëœ ê²ƒë§Œ)
            echo "ğŸ”¹ ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -f --filter "until=24h"

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
